description="Tools and library to manipulate EFI variables"
url="https://github.com/rhinstaller/efivar"

packager="Grat-OS Team"

makedepends=(popt)

name=efivar
version=37
_commit=cff88dd96b9d43e2c5875a24ba6180b196890ded
release=4

source=(http://repo.grat-os.fr/files/efivar-37.1.patch
        https://github.com/rhboot/efivar/archive/${_commit}.tar.gz)

x86_build() {

unset MAKEFLAGS
cd $name-${_commit}

patch -Np1 -i ../efivar-37.1.patch

# -Werror, not even once
#  sed -e 's/-Werror//g' -i gcc.specs

# remove insecure rpath in efivar-tester
  sed 's|-rpath,$(TOPDIR)/src|-rpath,$(libdir)|g' -i src/test/Makefile

make libdir=/usr/lib/ \
     bindir=/usr/bin/ \
     mandir=/usr/share/man/     \
     includedir=/usr/include/ \
     V=1 -j1

make -j1 V=1 \
     DESTDIR=${PKG}/ \
     libdir=/usr/lib/ \
     bindir=/usr/bin/ \
     mandir=/usr/share/man   \
     includedir=/usr/include/ \
     install

make -j1 V=1 \
     -C src/test \
     libdir=/usr/lib/ \
     bindir=/usr/bin/ \
     mandir=/usr/share/man   \
     includedir=/usr/include/

install -v -D -m0755 src/test/tester ${PKG}/usr/bin/efivar-tester
}

build() {

case $(uname -m) in
  x86_64|i686)
    x86_build
  ;;
  arm*|aarch64)
    echo "Nothing to do in Arm arch for the moment"
    mkdir -pv $PKG/usr
    cat > $PKGMK_ROOT/$name.post-install << EOF
source lib/lsb/init-functions
echo -e "\${FAILURE}Package $name is not available for ARM arch for the moment"
echo -e "Please remove the package as soon you have seen this message\${NORMAL}"
EOF
  ;;
esac
}
